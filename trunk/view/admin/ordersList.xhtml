<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:s="http://jboss.com/products/seam/taglib"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:a4j="http://richfaces.org/a4j"
    template="/layout/template.xhtml">
<ui:define name="title"> Заказы</ui:define>
<ui:define name="body">

    <a4j:loadStyle src="/stylesheet/admin.css" />

    <a4j:form>

    <h:selectBooleanCheckbox value="#{ordersList.incompleteOnly}">
        <a4j:support ajaxSingle="true" event="onchange" reRender="ordersList" />
    </h:selectBooleanCheckbox>
    <h:outputText value="Только незаверёшнные" />
    <h:outputText value="   " escape="false" />
        
    <a4j:commandButton value="Обновить" action="#{ordersList.invalidateResultList}" reRender="ordersList" ajaxSingle="true" />

    <div class="results">

    <rich:extendedDataTable id="ordersList"
                var="_order"
              value="#{ordersList.ordersDataModel}"
           rendered="#{not empty ordersList.resultList}"
            selectionMode="multi"
            selection="#{ordersList.selection}"
            rows="18"
            height="524px">
        <f:facet name="header">
             <h:outputText value="Заказы" />
        </f:facet>

        <rich:column width="45px" sortable="true" sortBy="#{_order.orderId}" sortOrder="DESCENDING" label="Номер">
            <f:facet name="header">
                <h:outputText value="Номер" />
            </f:facet>
            <h:outputText value="#{_order.orderId}" style="font-weight: bold;"/>
        </rich:column>
        
        <rich:column sortable="true" sortBy="#{_order.customer.city}"
                filterBy="#{_order.customer.city}" filterEvent="onkeyup" label="Город" width="100px">
            <f:facet name="header">
                <h:outputText value="Город" />
            </f:facet>
            <h:outputText value="#{_order.customer.city}"  styleClass="#{_order.status.styleClass}"/>
            <rich:toolTip>
                <h:outputText value="#{_order.customer.zip}, #{_order.customer.region}, #{_order.customer.area}, #{_order.customer.city}," /><br />
                <h:outputText value="#{_order.customer.address1}" />
            </rich:toolTip>
        </rich:column>

        <rich:column sortable="true" sortBy="#{_order.customer.firstName}"
                filterBy="#{_order.customer.firstName}" filterEvent="onkeyup"  label="Клиент" width="180px">
            <f:facet name="header">
                <h:outputText value="Клиент" />
            </f:facet>
            <h:outputText value="#{_order.customer.firstName} #{_order.customer.lastName}"  styleClass="#{_order.status.styleClass}"/>
            <rich:toolTip>              
                <h:outputText value="Тел.: #{_order.customer.phone}" /><br />
                <h:outputText value="Эл. почта: #{_order.customer.email}" rendered="#{_order.customer.email != null}" />
            </rich:toolTip>

        </rich:column>

        <rich:column sortable="true" sortBy="#{_order.totalAmount}" style="text-align: right; padding: 0 7px;" width="80px">
            <f:facet name="header">
                <h:outputText value="Стоимость" />
            </f:facet>
            <h:outputText value="#{_order.totalAmount}" styleClass="#{_order.status.styleClass}">
                <f:convertNumber type="currency" currencySymbol=""/>
            </h:outputText>
        </rich:column>

        <rich:column sortable="true" sortBy="#{_order.itemsQuantity}" style="text-align: right; padding: 0 9px;" width="70px">
            <f:facet name="header">
                <h:outputText value="Состав" />
            </f:facet>
            <h:outputText value="#{_order.itemsQuantity}" styleClass="#{_order.status.styleClass}" />
            <rich:toolTip>
                <table border="0">
                    <ui:repeat value="#{_order.orderLines}" var="line">
                        <tr>
                            <td style="padding-right: 9px;">#{line.product.ASIN}</td>
                            <td style="padding-right: 13px; text-align:left;">#{line.product.title}</td>
                            <td>#{line.quantity}</td>
                        </tr>
                    </ui:repeat>
                </table>
            </rich:toolTip>
        </rich:column>

        <rich:column sortable="true" sortBy="#{_order.status}" width="80px">
            <f:facet name="header">
                <h:outputText value="Статус" />
            </f:facet>
            <h:outputText value="#{_order.status}" styleClass="#{_order.status.styleClass}" />
        </rich:column>

        <rich:column sortable="true" sortBy="#{_order.orderDate}" width="70px">
            <f:facet name="header">
                <h:outputText value="Дата" />
            </f:facet>
            <h:outputText value="#{_order.orderDate}" styleClass="#{_order.status.styleClass}" />
        </rich:column>
        <rich:column styleClass="action" width="210px">
            <f:facet name="header">Действия</f:facet>
            <s:link view="/admin/#{empty from ? 'order' : from}.xhtml"
                   value="#{empty from ? 'View' : 'Select'}"
             propagation="#{empty from ? 'none' : 'default'}"
                      id="ordersViewId">
                <f:param name="id" value="#{_order.orderId}" />
            </s:link>
            #{' '}
            <s:link view="/admin/orderEdit.xhtml"
                   value="Edit"
             propagation="none"
                      id="orderEdit"
                rendered="#{empty from}">
                <f:param name="orderId"
                        value="#{_order.orderId}"/>
            </s:link>
            <a4j:commandLink value="Удалить" actionListener="#{ordersList.remove(_order)}" reRender="ordersList" />
            <a4j:commandLink value="Принять" rendered="#{_order.status.ordinal() == 0}" actionListener="#{ordersList.accept(_order)}" immediate="false" reRender="ordersList" />
            <a4j:commandLink value="Отправлен" rendered="#{_order.status.ordinal() == 2}" actionListener="#{ordersList.sent(_order)}" immediate="false" reRender="ordersList" />
            <a4j:commandLink value="Отменить" rendered="#{_order.status.ordinal() != 1}" actionListener="#{ordersList.cancel(_order)}" immediate="false" reRender="ordersList" />
        </rich:column>
        <f:facet name="footer">
             <rich:datascroller renderIfSinglePage="false" maxPages="7" ajaxSingle="true" for="ordersList" />
        </f:facet>
    </rich:extendedDataTable>

    </div>

    <s:div styleClass="actionButtons" rendered="#{empty from}">
        <s:button view="/admin/orderEdit.xhtml"
                    id="create"
           propagation="none"
                 value="Новый заказ">
            <f:param name="orderId"/>
        </s:button>
        <a4j:commandButton actionListener="#{ordersList.openSelection}" value="Открыть" reRender="ordersList" />
        <a4j:commandButton actionListener="#{ordersList.acceptSelection}" value="Принять" reRender="ordersList" />
        <a4j:commandButton actionListener="#{ordersList.sendSelection}" value="Отправить" reRender="ordersList" />
        <a4j:commandButton actionListener="#{ordersList.cancelSelection}" value="Отменить" reRender="ordersList" />
        <a4j:commandButton actionListener="#{ordersList.removeSelection}" value="Удалить" reRender="ordersList" />
        <a4j:commandButton oncomplete="#{rich:component('createBatchPanel')}.show()" value="Создать партию" reRender="ordersList" />
    </s:div>

    </a4j:form>

    <rich:modalPanel id="createBatchPanel" autosized="true" width="450">
        <f:facet name="header">
            <h:outputText value="Создать партию" />
        </f:facet>
        <f:facet name="controls">
            <h:panelGroup>
                <h:graphicImage value="/images/modal/close.png" id="hidepanellink"
                    styleClass="hidelink" />
                <rich:componentControl for="editPanel" attachTo="hidepanellink"
                    operation="hide" event="onclick" />
            </h:panelGroup>
        </f:facet>
        <h:form>
            <rich:messages style="color:red;"></rich:messages>
            <h:panelGrid columns="1">
                <a4j:outputPanel ajaxRendered="true">
                    <h:panelGrid columns="2">
                        <h:outputText value="Дата" />
                        <rich:calendar value="#{ordersList.batch.shipmentDate}" required="true" datePattern="d MMM yyyy"/>
                        <h:outputText value="ОПС" />
                        <h:inputText value="#{ordersList.batch.ops}" required="true" />
                    </h:panelGrid>
                </a4j:outputPanel>
                <a4j:commandButton value="Создать"
                    action="#{ordersList.createBatchFromSelection}"
                    oncomplete="if (#{facesContext.maximumSeverity==null}) #{rich:component('createBatchPanel')}.hide();" />
            </h:panelGrid>
        </h:form>
    </rich:modalPanel>

</ui:define>

</ui:composition>
