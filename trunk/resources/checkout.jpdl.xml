<?xml version="1.0"?>

<pageflow-definition
	xmlns="http://jboss.com/products/seam/pageflow"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation=
	    "http://jboss.com/products/seam/pageflow http://jboss.org/products/seam/pageflow-2.2.xsd"
 	name="checkout">
    <start-state name="start">
        <transition to="isLoggedIn"/>
    </start-state>


    <page view-id="/checkout.xhtml" name="checkout" back="enabled" >
        <end-conversation before-redirect="true"/>
        <redirect/>
    </page>

    <decision name="isLoggedIn" expression="#{identity.loggedIn}">
       <transition name="true" to="address"/>
       <transition name="false" to="auth"/>
    </decision>

    <decision name="isLoggedInBack" expression="#{identity.loggedIn}">
       <transition name="true" to="checkout"/>
       <transition name="false" to="auth"/>
    </decision>




    <page name="auth" view-id="/auth.xhtml"
            no-conversation-view-id="/checkout.xhtml" back="enabled">
        <redirect />
        <transition name="cancel" to="cancel"/>
        <transition name="back" to="checkout" />
        <transition name="auth" to="address" />
        <transition to="auth" />
    </page>



    <page name="address" view-id="/address.xhtml"
            no-conversation-view-id="/checkout.xhtml" back="enabled">
        <redirect />
        <transition name="cancel" to="cancel"/>
        <transition name="back" to="isLoggedInBack" />
        <transition name="address" to="confirm">
            <action expression="#{checkout.address}" />
        </transition>
    </page>

    <page name="pay" view-id="/pay.xhtml"
            no-conversation-view-id="/checkout.xhtml"  back="enabled">
        <redirect />
        <transition name="cancel" to="cancel"/>
        <transition name="back" to="address" />
        <transition name="pay" to="confirm">
                <action expression="#{checkout.pay}" />
        </transition>
    </page>



    <page name="confirm" view-id="/confirm.xhtml"
          no-conversation-view-id="/checkout.xhtml">
        <redirect />
        <transition name="cancel"   to="cancel"/>
        <transition name="back" to="address" />
        <transition name="purchase" to="complete">
            <action expression="#{checkout.submitOrder}" />
        </transition>
    </page>


    <page name="complete" view-id="/complete.xhtml">
        <end-conversation before-redirect="true"/>
    </page>

    <page name="cancel" view-id="/browse.xhtml">
        <!--<action expression="#{checkout.cancel}" />-->
	    <end-conversation before-redirect="true"/>
        <redirect/>
    </page>

</pageflow-definition>
