<?xml version="1.0" encoding="UTF-8"?>
<components xmlns="http://jboss.com/products/seam/components"
            xmlns:core="http://jboss.com/products/seam/core"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xmlns:persistence="http://jboss.com/products/seam/persistence"
            xmlns:framework="http://jboss.com/products/seam/framework"
            xmlns:web="http://jboss.com/products/seam/web"
            xsi:schemaLocation=
                    "http://jboss.com/products/seam/core http://jboss.com/products/seam/core-2.1.xsd
                    http://jboss.com/products/seam/web http://jboss.com/products/seam/web-2.2.xsd
               http://jboss.com/products/seam/components http://jboss.com/products/seam/components-2.1.xsd
               http://jboss.com/products/seam/framework http://jboss.com/products/seam/framework-2.2.xsd
               http://jboss.com/products/seam/persistence http://jboss.com/products/seam/persistence-2.2.xsd">

    <core:init debug="false"/>

    <core:manager conversation-timeout="120000"/>

    <persistence:entity-manager-factory name="extrastorefactory" persistence-unit-name="extrastore_pu_test"/>

    <!-- Strangely, <s:convertEntity /> fails with hard-to-trace NullPointerException, because "entityManger"
    injected variable name is hard-coded into seam persistence lib. So, we'd better use 'entityManager', not 'em' -->

    <persistence:managed-persistence-context name="entityManager" auto-create="true"
                                             entity-manager-factory="#{extrastorefactory}"/>


    <factory name="article" value="#{articleByAliasQuery.singleResult}" scope="STATELESS" auto-create="true"/>
    <framework:entity-query name="articleByAliasQuery"
                            max-results="1">
        <framework:ejbql>select a from Article a</framework:ejbql>

        <framework:restrictions>
            <value>lower(a.urlAlias) like lower(#{articleAlias})</value>
        </framework:restrictions>

    </framework:entity-query>



    <factory name="deliveryTypes" value="#{deliveryTypesForStoreQuery.resultList}" scope="STATELESS" auto-create="true"/>
    <framework:entity-query name="deliveryTypesForStoreQuery">
        <framework:ejbql>select dt from DeliveryType dt</framework:ejbql>

        <framework:restrictions>
            <value>dt.store = #{store}</value>
        </framework:restrictions>

    </framework:entity-query>



    <factory name="paymentTypes" value="#{paymentTypesForStoreQuery.resultList}" scope="STATELESS" auto-create="true"/>
    <framework:entity-query name="paymentTypesForStoreQuery">
        <framework:ejbql>select pt from PaymentType pt</framework:ejbql>

        <framework:restrictions>
            <value>pt.store = #{store}</value>
        </framework:restrictions>

    </framework:entity-query>



    <factory name="product" value="#{productByAliasQuery.singleResult}" scope="STATELESS" auto-create="true" />
    <framework:entity-query name="productByAliasQuery"
                            max-results="1">
        <framework:ejbql>select p from Product p</framework:ejbql>

        <framework:restrictions>
            <value>lower(p.urlAlias) like lower(#{alias})</value>
        </framework:restrictions>

    </framework:entity-query>

    <factory name="category"
             value="#{categoryHome.instance}"
             scope="STATELESS"
             auto-create="true" />

    <framework:entity-home name="categoryHome"
                           entity-class="ru.extrastore.model.Category"
                           scope="EVENT"
                           auto-create="true"
                            entity-manager="#{entityManager}">
    </framework:entity-home>


    <web:rewrite-filter view-mapping="*.seam"/>

</components>
